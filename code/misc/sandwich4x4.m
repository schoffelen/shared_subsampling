function z = sandwich4x4(x, y)

% SANDWICH4X4 compute x*y*x' provided y is Hermitian and dimensionality is
% 4x4xN, or Nx4x4. If N==4 it is treated as Nx4x4

% Copyright (C) 2017, Donders Centre for Cognitive Neuroimaging, Nijmegen, NL
%
% This file is part of FieldTrip, see http://www.fieldtriptoolbox.org
% for the documentation and details.
%
%    FieldTrip is free software: you can redistribute it and/or modify
%    it under the terms of the GNU General Public License as published by
%    the Free Software Foundation, either version 3 of the License, or
%    (at your option) any later version.
%
%    FieldTrip is distributed in the hope that it will be useful,
%    but WITHOUT ANY WARRANTY; without even the implied warranty of
%    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%    GNU General Public License for more details.
%
%    You should have received a copy of the GNU General Public License
%    along with FieldTrip. If not, see <http://www.gnu.org/licenses/>.
%
% $Id$

% FIXME build in check for hermitianity
siz   = size(x);
z     = complex(zeros(siz));
xconj = conj(x);
xabs2 = abs(x).^2;

if siz(2)==siz(3)
  z(:,1,1) = xabs2(:,1,1).*y(:,1,1)  + ...
    xabs2(:,1,2).*y(:,2,2)  + ...
    xabs2(:,1,3).*y(:,3,3)  + ...
    xabs2(:,1,4).*y(:,4,4)  + ...
    2.*real( x(:,1,2).*y(:,2,1).*xconj(:,1,1) ) + ...
    2.*real( x(:,1,3).*y(:,3,1).*xconj(:,1,1) ) + ...
    2.*real( x(:,1,4).*y(:,4,1).*xconj(:,1,1) ) + ...
    2.*real( x(:,1,3).*y(:,3,2).*xconj(:,1,2) ) + ...
    2.*real( x(:,1,4).*y(:,4,2).*xconj(:,1,2) ) + ...
    2.*real( x(:,1,4).*y(:,4,3).*xconj(:,1,3) );
  
  z(:,2,1) = (x(:,2,1).*y(:,1,1) + x(:,2,2).*y(:,2,1) + x(:,2,3).*y(:,3,1) + x(:,2,4).*y(:,4,1)).*xconj(:,1,1) + ...
    (x(:,2,1).*y(:,1,2) + x(:,2,2).*y(:,2,2) + x(:,2,3).*y(:,3,2) + x(:,2,4).*y(:,4,2)).*xconj(:,1,2) + ...
    (x(:,2,1).*y(:,1,3) + x(:,2,2).*y(:,2,3) + x(:,2,3).*y(:,3,3) + x(:,2,4).*y(:,4,3)).*xconj(:,1,3) + ...
    (x(:,2,1).*y(:,1,4) + x(:,2,2).*y(:,2,4) + x(:,2,3).*y(:,3,4) + x(:,2,4).*y(:,4,4)).*xconj(:,1,4);
  
  z(:,3,1) = (x(:,3,1).*y(:,1,1) + x(:,3,2).*y(:,2,1) + x(:,3,3).*y(:,3,1) + x(:,3,4).*y(:,4,1)).*xconj(:,1,1) + ...
    (x(:,3,1).*y(:,1,2) + x(:,3,2).*y(:,2,2) + x(:,3,3).*y(:,3,2) + x(:,3,4).*y(:,4,2)).*xconj(:,1,2) + ...
    (x(:,3,1).*y(:,1,3) + x(:,3,2).*y(:,2,3) + x(:,3,3).*y(:,3,3) + x(:,3,4).*y(:,4,3)).*xconj(:,1,3) + ...
    (x(:,3,1).*y(:,1,4) + x(:,3,2).*y(:,2,4) + x(:,3,3).*y(:,3,4) + x(:,3,4).*y(:,4,4)).*xconj(:,1,4);
  
  z(:,4,1) = (x(:,4,1).*y(:,1,1) + x(:,4,2).*y(:,2,1) + x(:,4,3).*y(:,3,1) + x(:,4,4).*y(:,4,1)).*xconj(:,1,1) + ...
    (x(:,4,1).*y(:,1,2) + x(:,4,2).*y(:,2,2) + x(:,4,3).*y(:,3,2) + x(:,4,4).*y(:,4,2)).*xconj(:,1,2) + ...
    (x(:,4,1).*y(:,1,3) + x(:,4,2).*y(:,2,3) + x(:,4,3).*y(:,3,3) + x(:,4,4).*y(:,4,3)).*xconj(:,1,3) + ...
    (x(:,4,1).*y(:,1,4) + x(:,4,2).*y(:,2,4) + x(:,4,3).*y(:,3,4) + x(:,4,4).*y(:,4,4)).*xconj(:,1,4);
  
  z(:,1,2) = conj(z(:,2,1));
  
  z(:,2,2) = xabs2(:,2,1).*y(:,1,1)  + ...
    xabs2(:,2,2).*y(:,2,2)  + ...
    xabs2(:,2,3).*y(:,3,3)  + ...
    xabs2(:,2,4).*y(:,4,4)  + ...
    2.*real( x(:,2,2).*y(:,2,1).*xconj(:,2,1) ) + ...
    2.*real( x(:,2,3).*y(:,3,1).*xconj(:,2,1) ) + ...
    2.*real( x(:,2,4).*y(:,4,1).*xconj(:,2,1) ) + ...
    2.*real( x(:,2,3).*y(:,3,2).*xconj(:,2,2) ) + ...
    2.*real( x(:,2,4).*y(:,4,2).*xconj(:,2,2) ) + ...
    2.*real( x(:,2,4).*y(:,4,3).*xconj(:,2,3) );
  
  z(:,3,2) = (x(:,3,1).*y(:,1,1) + x(:,3,2).*y(:,2,1) + x(:,3,3).*y(:,3,1) + x(:,3,4).*y(:,4,1)).*xconj(:,2,1) + ...
    (x(:,3,1).*y(:,1,2) + x(:,3,2).*y(:,2,2) + x(:,3,3).*y(:,3,2) + x(:,3,4).*y(:,4,2)).*xconj(:,2,2) + ...
    (x(:,3,1).*y(:,1,3) + x(:,3,2).*y(:,2,3) + x(:,3,3).*y(:,3,3) + x(:,3,4).*y(:,4,3)).*xconj(:,2,3) + ...
    (x(:,3,1).*y(:,1,4) + x(:,3,2).*y(:,2,4) + x(:,3,3).*y(:,3,4) + x(:,3,4).*y(:,4,4)).*xconj(:,2,4);
  
  z(:,4,2) = (x(:,4,1).*y(:,1,1) + x(:,4,2).*y(:,2,1) + x(:,4,3).*y(:,3,1) + x(:,4,4).*y(:,4,1)).*xconj(:,2,1) + ...
    (x(:,4,1).*y(:,1,2) + x(:,4,2).*y(:,2,2) + x(:,4,3).*y(:,3,2) + x(:,4,4).*y(:,4,2)).*xconj(:,2,2) + ...
    (x(:,4,1).*y(:,1,3) + x(:,4,2).*y(:,2,3) + x(:,4,3).*y(:,3,3) + x(:,4,4).*y(:,4,3)).*xconj(:,2,3) + ...
    (x(:,4,1).*y(:,1,4) + x(:,4,2).*y(:,2,4) + x(:,4,3).*y(:,3,4) + x(:,4,4).*y(:,4,4)).*xconj(:,2,4);
  
  z(:,1,3) = conj(z(:,3,1));
  
  z(:,2,3) = conj(z(:,3,2));
  
  z(:,3,3) = xabs2(:,3,1).*y(:,1,1)  + ...
    xabs2(:,3,2).*y(:,2,2)  + ...
    xabs2(:,3,3).*y(:,3,3)  + ...
    xabs2(:,3,4).*y(:,4,4)  + ...
    2.*real( x(:,3,2).*y(:,2,1).*xconj(:,3,1) ) + ...
    2.*real( x(:,3,3).*y(:,3,1).*xconj(:,3,1) ) + ...
    2.*real( x(:,3,4).*y(:,4,1).*xconj(:,3,1) ) + ...
    2.*real( x(:,3,3).*y(:,3,2).*xconj(:,3,2) ) + ...;
    2.*real( x(:,3,4).*y(:,4,2).*xconj(:,3,2) ) + ...;
    2.*real( x(:,3,4).*y(:,4,3).*xconj(:,3,3) );
  
  z(:,4,3) = (x(:,4,1).*y(:,1,1) + x(:,4,2).*y(:,2,1) + x(:,4,3).*y(:,3,1) + x(:,4,4).*y(:,4,1)).*xconj(:,3,1) + ...
    (x(:,4,1).*y(:,1,2) + x(:,4,2).*y(:,2,2) + x(:,4,3).*y(:,3,2) + x(:,4,4).*y(:,4,2)).*xconj(:,3,2) + ...
    (x(:,4,1).*y(:,1,3) + x(:,4,2).*y(:,2,3) + x(:,4,3).*y(:,3,3) + x(:,4,4).*y(:,4,3)).*xconj(:,3,3) + ...
    (x(:,4,1).*y(:,1,4) + x(:,4,2).*y(:,2,4) + x(:,4,3).*y(:,3,4) + x(:,4,4).*y(:,4,4)).*xconj(:,3,4);
  
  z(:,1,4) = conj(z(:,4,1));
  
  z(:,2,4) = conj(z(:,4,2));
  
  z(:,3,4) = conj(z(:,4,3));
  
  z(:,4,4) = xabs2(:,4,1).*y(:,1,1)  + ...
    xabs2(:,4,2).*y(:,2,2)  + ...
    xabs2(:,4,3).*y(:,3,3)  + ...
    xabs2(:,4,4).*y(:,4,4)  + ...
    2.*real( x(:,4,2).*y(:,2,1).*xconj(:,4,1) ) + ...
    2.*real( x(:,4,3).*y(:,3,1).*xconj(:,4,1) ) + ...
    2.*real( x(:,4,4).*y(:,4,1).*xconj(:,4,1) ) + ...
    2.*real( x(:,4,3).*y(:,3,2).*xconj(:,4,2) ) + ...;
    2.*real( x(:,4,4).*y(:,4,2).*xconj(:,4,2) ) + ...;
    2.*real( x(:,4,4).*y(:,4,3).*xconj(:,4,3) );
  
elseif siz(1)==siz(2)
  z(1,1,:,:) = xabs2(1,1,:,:).*y(1,1,:,:)  + ...
    xabs2(1,2,:,:).*y(2,2,:,:)  + ...
    xabs2(1,3,:,:).*y(3,3,:,:)  + ...
    xabs2(1,4,:,:).*y(4,4,:,:)  + ...
    2.*real( x(1,2,:,:).*y(2,1,:,:).*xconj(1,1,:,:) ) + ...
    2.*real( x(1,3,:,:).*y(3,1,:,:).*xconj(1,1,:,:) ) + ...
    2.*real( x(1,4,:,:).*y(4,1,:,:).*xconj(1,1,:,:) ) + ...
    2.*real( x(1,3,:,:).*y(3,2,:,:).*xconj(1,2,:,:) ) + ...
    2.*real( x(1,4,:,:).*y(4,2,:,:).*xconj(1,2,:,:) ) + ...
    2.*real( x(1,4,:,:).*y(4,3,:,:).*xconj(1,3,:,:) );
  
  z(2,1,:,:) = (x(2,1,:,:).*y(1,1,:,:) + x(2,2,:,:).*y(2,1,:,:) + x(2,3,:,:).*y(3,1,:,:) + x(2,4,:,:).*y(4,1,:,:)).*xconj(1,1,:,:) + ...
    (x(2,1,:,:).*y(1,2,:,:) + x(2,2,:,:).*y(2,2,:,:) + x(2,3,:,:).*y(3,2,:,:) + x(2,4,:,:).*y(4,2,:,:)).*xconj(1,2,:,:) + ...
    (x(2,1,:,:).*y(1,3,:,:) + x(2,2,:,:).*y(2,3,:,:) + x(2,3,:,:).*y(3,3,:,:) + x(2,4,:,:).*y(4,3,:,:)).*xconj(1,3,:,:) + ...
    (x(2,1,:,:).*y(1,4,:,:) + x(2,2,:,:).*y(2,4,:,:) + x(2,3,:,:).*y(3,4,:,:) + x(2,4,:,:).*y(4,4,:,:)).*xconj(1,4,:,:);
  
  z(3,1,:,:) = (x(3,1,:,:).*y(1,1,:,:) + x(3,2,:,:).*y(2,1,:,:) + x(3,3,:,:).*y(3,1,:,:) + x(3,4,:,:).*y(4,1,:,:)).*xconj(1,1,:,:) + ...
    (x(3,1,:,:).*y(1,2,:,:) + x(3,2,:,:).*y(2,2,:,:) + x(3,3,:,:).*y(3,2,:,:) + x(3,4,:,:).*y(4,2,:,:)).*xconj(1,2,:,:) + ...
    (x(3,1,:,:).*y(1,3,:,:) + x(3,2,:,:).*y(2,3,:,:) + x(3,3,:,:).*y(3,3,:,:) + x(3,4,:,:).*y(4,3,:,:)).*xconj(1,3,:,:) + ...
    (x(3,1,:,:).*y(1,4,:,:) + x(3,2,:,:).*y(2,4,:,:) + x(3,3,:,:).*y(3,4,:,:) + x(3,4,:,:).*y(4,4,:,:)).*xconj(1,4,:,:);
  
  z(4,1,:,:) = (x(4,1,:,:).*y(1,1,:,:) + x(4,2,:,:).*y(2,1,:,:) + x(4,3,:,:).*y(3,1,:,:) + x(4,4,:,:).*y(4,1,:,:)).*xconj(1,1,:,:) + ...
    (x(4,1,:,:).*y(1,2,:,:) + x(4,2,:,:).*y(2,2,:,:) + x(4,3,:,:).*y(3,2,:,:) + x(4,4,:,:).*y(4,2,:,:)).*xconj(1,2,:,:) + ...
    (x(4,1,:,:).*y(1,3,:,:) + x(4,2,:,:).*y(2,3,:,:) + x(4,3,:,:).*y(3,3,:,:) + x(4,4,:,:).*y(4,3,:,:)).*xconj(1,3,:,:) + ...
    (x(4,1,:,:).*y(1,4,:,:) + x(4,2,:,:).*y(2,4,:,:) + x(4,3,:,:).*y(3,4,:,:) + x(4,4,:,:).*y(4,4,:,:)).*xconj(1,4,:,:);
  
  z(1,2,:,:) = conj(z(2,1,:,:));
  
  z(2,2,:,:) = xabs2(2,1,:,:).*y(1,1,:,:)  + ...
    xabs2(2,2,:,:).*y(2,2,:,:)  + ...
    xabs2(2,3,:,:).*y(3,3,:,:)  + ...
    xabs2(2,4,:,:).*y(4,4,:,:)  + ...
    2.*real( x(2,2,:,:).*y(2,1,:,:).*xconj(2,1,:,:) ) + ...
    2.*real( x(2,3,:,:).*y(3,1,:,:).*xconj(2,1,:,:) ) + ...
    2.*real( x(2,4,:,:).*y(4,1,:,:).*xconj(2,1,:,:) ) + ...
    2.*real( x(2,3,:,:).*y(3,2,:,:).*xconj(2,2,:,:) ) + ...
    2.*real( x(2,4,:,:).*y(4,2,:,:).*xconj(2,2,:,:) ) + ...
    2.*real( x(2,4,:,:).*y(4,3,:,:).*xconj(2,3,:,:) );
  
  z(3,2,:,:) = (x(3,1,:,:).*y(1,1,:,:) + x(3,2,:,:).*y(2,1,:,:) + x(3,3,:,:).*y(3,1,:,:) + x(3,4,:,:).*y(4,1,:,:)).*xconj(2,1,:,:) + ...
    (x(3,1,:,:).*y(1,2,:,:) + x(3,2,:,:).*y(2,2,:,:) + x(3,3,:,:).*y(3,2,:,:) + x(3,4,:,:).*y(4,2,:,:)).*xconj(2,2,:,:) + ...
    (x(3,1,:,:).*y(1,3,:,:) + x(3,2,:,:).*y(2,3,:,:) + x(3,3,:,:).*y(3,3,:,:) + x(3,4,:,:).*y(4,3,:,:)).*xconj(2,3,:,:) + ...
    (x(3,1,:,:).*y(1,4,:,:) + x(3,2,:,:).*y(2,4,:,:) + x(3,3,:,:).*y(3,4,:,:) + x(3,4,:,:).*y(4,4,:,:)).*xconj(2,4,:,:);
  
  z(4,2,:,:) = (x(4,1,:,:).*y(1,1,:,:) + x(4,2,:,:).*y(2,1,:,:) + x(4,3,:,:).*y(3,1,:,:) + x(4,4,:,:).*y(4,1,:,:)).*xconj(2,1,:,:) + ...
    (x(4,1,:,:).*y(1,2,:,:) + x(4,2,:,:).*y(2,2,:,:) + x(4,3,:,:).*y(3,2,:,:) + x(4,4,:,:).*y(4,2,:,:)).*xconj(2,2,:,:) + ...
    (x(4,1,:,:).*y(1,3,:,:) + x(4,2,:,:).*y(2,3,:,:) + x(4,3,:,:).*y(3,3,:,:) + x(4,4,:,:).*y(4,3,:,:)).*xconj(2,3,:,:) + ...
    (x(4,1,:,:).*y(1,4,:,:) + x(4,2,:,:).*y(2,4,:,:) + x(4,3,:,:).*y(3,4,:,:) + x(4,4,:,:).*y(4,4,:,:)).*xconj(2,4,:,:);
  
  z(1,3,:,:) = conj(z(3,1,:,:));
  
  z(2,3,:,:) = conj(z(3,2,:,:));
  
  z(3,3,:,:) = xabs2(3,1,:,:).*y(1,1,:,:)  + ...
    xabs2(3,2,:,:).*y(2,2,:,:)  + ...
    xabs2(3,3,:,:).*y(3,3,:,:)  + ...
    xabs2(3,4,:,:).*y(4,4,:,:)  + ...
    2.*real( x(3,2,:,:).*y(2,1,:,:).*xconj(3,1,:,:) ) + ...
    2.*real( x(3,3,:,:).*y(3,1,:,:).*xconj(3,1,:,:) ) + ...
    2.*real( x(3,4,:,:).*y(4,1,:,:).*xconj(3,1,:,:) ) + ...
    2.*real( x(3,3,:,:).*y(3,2,:,:).*xconj(3,2,:,:) ) + ...;
    2.*real( x(3,4,:,:).*y(4,2,:,:).*xconj(3,2,:,:) ) + ...;
    2.*real( x(3,4,:,:).*y(4,3,:,:).*xconj(3,3,:,:) );
  
  z(4,3,:,:) = (x(4,1,:,:).*y(1,1,:,:) + x(4,2,:,:).*y(2,1,:,:) + x(4,3,:,:).*y(3,1,:,:) + x(4,4,:,:).*y(4,1,:,:)).*xconj(3,1,:,:) + ...
    (x(4,1,:,:).*y(1,2,:,:) + x(4,2,:,:).*y(2,2,:,:) + x(4,3,:,:).*y(3,2,:,:) + x(4,4,:,:).*y(4,2,:,:)).*xconj(3,2,:,:) + ...
    (x(4,1,:,:).*y(1,3,:,:) + x(4,2,:,:).*y(2,3,:,:) + x(4,3,:,:).*y(3,3,:,:) + x(4,4,:,:).*y(4,3,:,:)).*xconj(3,3,:,:) + ...
    (x(4,1,:,:).*y(1,4,:,:) + x(4,2,:,:).*y(2,4,:,:) + x(4,3,:,:).*y(3,4,:,:) + x(4,4,:,:).*y(4,4,:,:)).*xconj(3,4,:,:);
  
  z(1,4,:,:) = conj(z(4,1,:,:));
  
  z(2,4,:,:) = conj(z(4,2,:,:));
  
  z(3,4,:,:) = conj(z(4,3,:,:));
  
  z(4,4,:,:) = xabs2(4,1,:,:).*y(1,1,:,:)  + ...
    xabs2(4,2,:,:).*y(2,2,:,:)  + ...
    xabs2(4,3,:,:).*y(3,3,:,:)  + ...
    xabs2(4,4,:,:).*y(4,4,:,:)  + ...
    2.*real( x(4,2,:,:).*y(2,1,:,:).*xconj(4,1,:,:) ) + ...
    2.*real( x(4,3,:,:).*y(3,1,:,:).*xconj(4,1,:,:) ) + ...
    2.*real( x(4,4,:,:).*y(4,1,:,:).*xconj(4,1,:,:) ) + ...
    2.*real( x(4,3,:,:).*y(3,2,:,:).*xconj(4,2,:,:) ) + ...;
    2.*real( x(4,4,:,:).*y(4,2,:,:).*xconj(4,2,:,:) ) + ...;
    2.*real( x(4,4,:,:).*y(4,3,:,:).*xconj(4,3,:,:) );
else
  error('unsupported dimensionality in the input');
end
