function [z] = mtimes4x4(x, y)

% compute x*y 
% and dimensionatity is 4x4xN, or Nx4x4
% if N==4 it is treated as Nx4x4

siz = size(x);
z   = complex(zeros(siz));
if siz(2)==siz(3)
  z(:,1,1)=x(:,1,1).*y(:,1,1)+x(:,1,2).*y(:,2,1)+x(:,1,3).*y(:,3,1)+x(:,1,4).*y(:,4,1);
  z(:,2,1)=x(:,2,1).*y(:,1,1)+x(:,2,2).*y(:,2,1)+x(:,2,3).*y(:,3,1)+x(:,2,4).*y(:,4,1);
  z(:,3,1)=x(:,3,1).*y(:,1,1)+x(:,3,2).*y(:,2,1)+x(:,3,3).*y(:,3,1)+x(:,3,4).*y(:,4,1);
  z(:,4,1)=x(:,4,1).*y(:,1,1)+x(:,4,2).*y(:,2,1)+x(:,4,3).*y(:,3,1)+x(:,4,4).*y(:,4,1);
  z(:,1,2)=x(:,1,1).*y(:,1,2)+x(:,1,2).*y(:,2,2)+x(:,1,3).*y(:,3,2)+x(:,1,4).*y(:,4,2);
  z(:,2,2)=x(:,2,1).*y(:,1,2)+x(:,2,2).*y(:,2,2)+x(:,2,3).*y(:,3,2)+x(:,2,4).*y(:,4,2);
  z(:,3,2)=x(:,3,1).*y(:,1,2)+x(:,3,2).*y(:,2,2)+x(:,3,3).*y(:,3,2)+x(:,3,4).*y(:,4,2);
  z(:,4,2)=x(:,4,1).*y(:,1,2)+x(:,4,2).*y(:,2,2)+x(:,4,3).*y(:,3,2)+x(:,4,4).*y(:,4,2);
  z(:,1,3)=x(:,1,1).*y(:,1,3)+x(:,1,2).*y(:,2,3)+x(:,1,3).*y(:,3,3)+x(:,1,4).*y(:,4,3);
  z(:,2,3)=x(:,2,1).*y(:,1,3)+x(:,2,2).*y(:,2,3)+x(:,2,3).*y(:,3,3)+x(:,2,4).*y(:,4,3);
  z(:,3,3)=x(:,3,1).*y(:,1,3)+x(:,3,2).*y(:,2,3)+x(:,3,3).*y(:,3,3)+x(:,3,4).*y(:,4,3);
  z(:,4,3)=x(:,4,1).*y(:,1,3)+x(:,4,2).*y(:,2,3)+x(:,4,3).*y(:,3,3)+x(:,4,4).*y(:,4,3);
  z(:,1,4)=x(:,1,1).*y(:,1,4)+x(:,1,2).*y(:,2,4)+x(:,1,3).*y(:,3,4)+x(:,1,4).*y(:,4,4);
  z(:,2,4)=x(:,2,1).*y(:,1,4)+x(:,2,2).*y(:,2,4)+x(:,2,3).*y(:,3,4)+x(:,2,4).*y(:,4,4);
  z(:,3,4)=x(:,3,1).*y(:,1,4)+x(:,3,2).*y(:,2,4)+x(:,3,3).*y(:,3,4)+x(:,3,4).*y(:,4,4);
  z(:,4,4)=x(:,4,1).*y(:,1,4)+x(:,4,2).*y(:,2,4)+x(:,4,3).*y(:,3,4)+x(:,4,4).*y(:,4,4);

  
elseif siz(1)==siz(2)
  z(1,1,:,:)=x(1,1,:,:).*y(1,1,:,:)+x(1,2,:,:).*y(2,1,:,:)+x(1,3,:,:).*y(3,1,:,:)+x(1,4,:,:).*y(4,1,:,:);
  z(2,1,:,:)=x(2,1,:,:).*y(1,1,:,:)+x(2,2,:,:).*y(2,1,:,:)+x(2,3,:,:).*y(3,1,:,:)+x(2,4,:,:).*y(4,1,:,:);
  z(3,1,:,:)=x(3,1,:,:).*y(1,1,:,:)+x(3,2,:,:).*y(2,1,:,:)+x(3,3,:,:).*y(3,1,:,:)+x(3,4,:,:).*y(4,1,:,:);
  z(4,1,:,:)=x(4,1,:,:).*y(1,1,:,:)+x(4,2,:,:).*y(2,1,:,:)+x(4,3,:,:).*y(3,1,:,:)+x(4,4,:,:).*y(4,1,:,:);
  z(1,2,:,:)=x(1,1,:,:).*y(1,2,:,:)+x(1,2,:,:).*y(2,2,:,:)+x(1,3,:,:).*y(3,2,:,:)+x(1,4,:,:).*y(4,2,:,:);
  z(2,2,:,:)=x(2,1,:,:).*y(1,2,:,:)+x(2,2,:,:).*y(2,2,:,:)+x(2,3,:,:).*y(3,2,:,:)+x(2,4,:,:).*y(4,2,:,:);
  z(3,2,:,:)=x(3,1,:,:).*y(1,2,:,:)+x(3,2,:,:).*y(2,2,:,:)+x(3,3,:,:).*y(3,2,:,:)+x(3,4,:,:).*y(4,2,:,:);
  z(4,2,:,:)=x(4,1,:,:).*y(1,2,:,:)+x(4,2,:,:).*y(2,2,:,:)+x(4,3,:,:).*y(3,2,:,:)+x(4,4,:,:).*y(4,2,:,:);
  z(1,3,:,:)=x(1,1,:,:).*y(1,3,:,:)+x(1,2,:,:).*y(2,3,:,:)+x(1,3,:,:).*y(3,3,:,:)+x(1,4,:,:).*y(4,3,:,:);
  z(2,3,:,:)=x(2,1,:,:).*y(1,3,:,:)+x(2,2,:,:).*y(2,3,:,:)+x(2,3,:,:).*y(3,3,:,:)+x(2,4,:,:).*y(4,3,:,:);
  z(3,3,:,:)=x(3,1,:,:).*y(1,3,:,:)+x(3,2,:,:).*y(2,3,:,:)+x(3,3,:,:).*y(3,3,:,:)+x(3,4,:,:).*y(4,3,:,:);
  z(4,3,:,:)=x(4,1,:,:).*y(1,3,:,:)+x(4,2,:,:).*y(2,3,:,:)+x(4,3,:,:).*y(3,3,:,:)+x(4,4,:,:).*y(4,3,:,:);
  z(1,4,:,:)=x(1,1,:,:).*y(1,4,:,:)+x(1,2,:,:).*y(2,4,:,:)+x(1,3,:,:).*y(3,4,:,:)+x(1,4,:,:).*y(4,4,:,:);
  z(2,4,:,:)=x(2,1,:,:).*y(1,4,:,:)+x(2,2,:,:).*y(2,4,:,:)+x(2,3,:,:).*y(3,4,:,:)+x(2,4,:,:).*y(4,4,:,:);
  z(3,4,:,:)=x(3,1,:,:).*y(1,4,:,:)+x(3,2,:,:).*y(2,4,:,:)+x(3,3,:,:).*y(3,4,:,:)+x(3,4,:,:).*y(4,4,:,:);
  z(4,4,:,:)=x(4,1,:,:).*y(1,4,:,:)+x(4,2,:,:).*y(2,4,:,:)+x(4,3,:,:).*y(3,4,:,:)+x(4,4,:,:).*y(4,4,:,:);
else
  error('unsupported dimensionality in the input');
end
